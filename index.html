<!doctype html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The 01</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Poppins:wght@600;700&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #0a0a0f;
      color: #e5e7eb;
      font-family: Inter, system-ui, sans-serif;
    }

    .main-title {
      font-family: Poppins, Inter, sans-serif;
      font-size: 2.7rem;
      font-weight: 700;
      color: #fff;
      text-align: center;
      margin-top: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .post-list {
      max-width: 700px;
      margin: 2rem auto;
    }

    .post-card {
      background: #18181b;
      border-radius: 1.2rem;
      padding: 1.3rem 2rem;
      margin-bottom: 1.2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background-color 0.2s;
    }

    .post-card:hover {
      background: #23272a;
    }

    .post-title-link {
      font-size: 1.3rem;
      font-weight: 600;
      color: #fff;
      text-decoration: none;
      font-family: Poppins, Inter, sans-serif;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }

    .post-title-link:hover {
      color: #0ea5e9;
    }

    .post-date {
      color: #bcbcbc;
      font-size: 1rem;
      margin-top: 0.2rem;
      font-family: Inter, sans-serif;
    }
  </style>
</head>

<body>
  <div class="main-title">The 01</div>
  <div id="posts" class="post-list"></div>

  <script>
    const CACHE_KEY = "cached_posts_v1";
    const CACHE_MS = 5 * 60 * 1000; // 5 minutes

    // Parse YAML frontmatter (--- ... ---) from raw markdown
    function parseFrontmatter(md) {
      const m = md.match(/^---\s*([\s\S]*?)\s*---/);
      const meta = {};
      let body = md;
      if (m) {
        m[1].split("\n").forEach(line => {
          const [k, ...rest] = line.split(":");
          if (k && rest.length) meta[k.trim()] = rest.join(":").trim().replace(/^"|"$/g, "");
        });
        body = md.slice(m[0].length).trim();
      }
      return { meta, body };
    }

    function renderPosts(posts) {
      const el = document.getElementById("posts");
      el.innerHTML = posts.length
        ? posts.map(post => `
          <div class="post-card">
            ${post.image ? `
              <div style="
                width: 100%;
                max-width: 360px;
                margin-bottom: 1.1rem;
                border-radius: 1.1rem;
                overflow: hidden;
                display: flex;
                justify-content: center;
                align-items: center;
                background: #23272a;
              ">
                <img src="${post.image}" alt="Post image" style="width: 100%; height: 180px; object-fit: cover; border-radius: 1.1rem;">
              </div>
            ` : ""}
            <a class="post-title-link flex items-center gap-2 group" href="post.html?file=${encodeURIComponent(post.path)}">
              <span>${post.title}</span>
              <span class="text-xl text-[#0ea5e9] group-hover:translate-x-1 transition-transform">&rarr;</span>
            </a>
            <div class="post-date">${post.date || ""}</div>
          </div>
        `).join("")
        : `<div style="text-align:center;color:#bcbcbc;">No posts yet.</div>`;
    }

    async function loadFromLocal() {
      // 1) fetch list of posts (generated by the Action)
      const listRes = await fetch("posts/posts.json", { cache: "no-cache" });
      if (!listRes.ok) throw new Error("posts.json missing");
      const list = await listRes.json(); // [{ title?, path: "posts/xxx.md"}]

      // 2) fetch each markdown from your own site (no API, no rate limit)
      const posts = (await Promise.all(list.map(async (item) => {
        try {
          const mdRes = await fetch(item.path, { cache: "no-cache" });
          if (!mdRes.ok) return null;
          const md = await mdRes.text();
          const { meta } = parseFrontmatter(md);
          return {
            title: meta.title || item.title || item.path.replace(/^posts\/|\.md$/g, ""),
            date: meta.date || "",
            image: meta.image || "",
            path: item.path
          };
        } catch {
          return null;
        }
      }))).filter(Boolean);

      // newest first if date present
      posts.sort((a, b) => (b.date || "").localeCompare(a.date || ""));
      return posts;
    }

    async function loadPosts() {
      const container = document.getElementById("posts");
      container.innerHTML = `<div style="text-align:center;color:#bcbcbc;">Loading...</div>`;

      // Use cache if fresh
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const { posts, t } = JSON.parse(cached);
        if (Date.now() - t < CACHE_MS) {
          renderPosts(posts);
          return;
        }
      }

      try {
        const posts = await loadFromLocal();             // <- primary (no API)
        localStorage.setItem(CACHE_KEY, JSON.stringify({ posts, t: Date.now() }));
        renderPosts(posts);
      } catch (e) {
        container.innerHTML = `<div style="text-align:center;color:#f87171;">Failed to load posts.</div>`;
        console.error(e);
      }
    }

    loadPosts();
  </script>
</body>

</html>